# fluentd-humio
Fluentd Docker image that ships data to Humio

## Overview
This [Docker image](https://hub.docker.com/r/lucamora/fluentd-humio/) is based on [docker2humio](https://github.com/pmech/docker2humio) image that is able to send Docker container logs to [Humio](https://www.humio.com).

At the core of fluentd-humio there is [fluentd](https://www.fluentd.org): an open source data collector for unified logging layer.

## Shipped log format
The original log that Docker daemon sends to shipper container is manipulated before being sent to Humio to remove useless data (e.g. `source` field in Docker logs) and define some useful fields.

#### Outgoing log format
```json
{
	"message": "<CONTAINER_LOG>",
	"service": "<SERVICE_NAME>",
	"@type": "<HUMIO_DOCKER>",
	"@container": "<YOUR_APP_CONTAINER_ID>",
	"@shipper": "<SHIPPER_CONTAINER_ID>"
}
```
Where:
- `<CONTAINER_LOG>`: is the log generated by your app, read by Docker daemon and sent to the shipper in the `log` field
- `<SERVICE_NAME>`: is the name of your application configured on contianer creation ([see setup container](#setup-docker-container))
- `<HUMIO_DOCKER>`: is the parser that Humio use to parse the log ([see setup shipper](#setup-shipper-container))
- `<YOUR_APP_CONTAINER_ID>`: is the ID of your app's container generated by the Docker daemon
- `<SHIPPER_CONTAINER_ID>`: is the ID of the shipper container generated by the Docker daemon

## Future improvements
At the moment this image sends only Docker container logs received with the **forward** protocol, but future versions will be able to ship also other source of data like [nginx](http://nginx.org) and [mongodb](https://www.mongodb.com) logs.

## Setup shipper container
To run the shipper container, four environment variables must be set:
- `HUMIO_HOST`: Humio URL
- `HUMIO_TOKEN`: Humio ingest token
- `HUMIO_DATASPACE`: Humio dataspace
- `HUMIO_DOCKER`: parser used in Humio to parse logs generated by Docker container

The easiest method to run the shipper is to create a standalone Docker container.

#### Docker command
```bash
docker run \
-d \
-p 24224:24224 \
-e HUMIO_HOST=https://cloud.humio.com:443 \
-e HUMIO_TOKEN=<INGEST_TOKEN> \
-e HUMIO_DATASPACE=<DATASPACE> \
-e HUMIO_DOCKER=<PARSER> \
--name shipper \
lucamora/fluentd-humio:1.0.0
```

Another way to run the shipper is to use the compose file (**suggested method**):

*This example assumes that a swarm has already been initialized*

#### docker-compose.yml file
```yaml
version: "3"
services:
  shipper:
    image: lucamora/fluentd-humio:1.0.0
    deploy:
      mode: global
      restart_policy:
        condition: any
    ports:
      - "24224:24224"
    environment:
      HUMIO_HOST: https://cloud.humio.com:443
      HUMIO_TOKEN: <INGEST_TOKEN>
      HUMIO_DATASPACE: <DATASPACE>
      HUMIO_DOCKER: <PARSER>
```

#### Docker command
```bash
docker stack deploy -c docker-compose.yml humio
```

## Setup Docker container
To enable log shipping for a container some configuration has to be setup.
First the `--log-driver` option must be set to `fluentd`, then **two logging option** have to be configured with `--log-opt` and finally a `label` has to be defined to identify the log source in Humio dashboard.

The easiest method to configure the container is to run it in standalone mode.

#### Docker command
```bash
docker run \
--log-driver=fluentd \
--log-opt tag="docker.{{.ID}}" \
--log-opt labels="service" \
--label service=<SERVICE_NAME>
<YOUR_IMAGE>
```

Another way to configure the container is to use the compose file (**suggested method**):

*This example assumes that a swarm has already been initialized*

#### docker-compose.yml file
```yaml
version: "3"
services:
  web:
    image: <YOUR_IMAGE>
    logging:
      driver: fluentd
      options:
        tag: docker.{{.ID}}
        labels: "service"
    labels:
      service: <SERVICE_NAME>
```

#### Docker command
```bash
docker stack deploy -c docker-compose.yml <STACK_NAME>
```

## Custom configuration
If you want to edit the configuration file without building your own image you can edit the [original file](https://github.com/lucamora/fluentd-humio/blob/master/fluent.conf) and then bind it into the Docker container using the `-v` option.

If you run your app in standalone mode:

#### Docker command
```bash
docker run \
... \
-v "path/to/your/fluent.conf:/fluentd/etc/" \
lucamora/fluentd-humio:1.0.0
```

Or if you use the docker-compose file

#### docker-compose.yml file
```yaml
version: "3"
services:
  shipper:
    image: lucamora/fluentd-humio:1.0.0
    ...
    volumes:
      - "path/to/your/fluent.conf:/fluentd/etc/"
```